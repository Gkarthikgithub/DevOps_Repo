
name: Build and Deploy to AuditRite environment

on:
  push:
    branches:
      - main    ####

jobs:
  build:
    runs-on: ubuntu-latest
   

    steps:
      - name: Checkout code
        uses: actions/checkout@v2
        with:
          fetch-depth: 2  

      - name: Fetch the commit history
        run: git fetch --no-tags --prune --depth=2 origin ${{ github.ref }}

      - name: Get changes
        run: git diff --name-only -r HEAD^1 HEAD
      - name: Set up JDK 17
        uses: actions/setup-java@v4  
        with:
         java-version: '17'
         distribution: 'temurin'
         cache: 'maven'
      - name: Setup Maven
        uses: s4u/setup-maven-action@v1.4.0  
        with:
         java-version: 17
      - name: maven build
        run: mvn -f pom.xml install -Dmaven.test.skip=true
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2
      - name: Login to OCIR
        uses: docker/login-action@v3
        with:
          registry: iad.ocir.io
          username: ${{ secrets.IT_ADMIN_USER_ID }}
          password: ${{ secrets.IT_ADMIN_AUTH_TOKEN }}
         
      - name: Build the  Docker Image
        run: |
        
         docker build  --no-cache -t sod-service:latest  .
         
      - name: Set Docker tag
        run: echo "DOCKER_TAG=sod-${GITHUB_RUN_NUMBER}-$(date +'%Y%m%d')" >> $GITHUB_ENV

      - name: Tag Docker image
        run: |
         docker tag sod-service:latest iad.ocir.io/idjm2yj32zav/auditrite:${{ env.DOCKER_TAG }}

      - name: Push Docker Image to OCIR
        run: |
         docker push iad.ocir.io/idjm2yj32zav/auditrite:${{ env.DOCKER_TAG }}
        
        
      - name: Set up SSH key
        uses: webfactory/ssh-agent@v0.5.3
        with:
          ssh-private-key: ${{ secrets.AR_SSH_KEY }}

      - name: SSH into Server and Run Docker Commands
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.AR_HOST }}
          username: ${{ secrets.AR_USERNAME }}
          key: ${{ secrets.AR_SSH_KEY }}
          port: ${{ secrets.SSH_PORT }}
          script: |
             echo "Running on $(hostname)"
             docker pull iad.ocir.io/idjm2yj32zav/auditrite:${{ env.DOCKER_TAG }}
             docker stop sod
             docker rm sod
              prev_run_number=$(( ${{ github.run_number }} - 1 ))
              prev_tag=sod-${prev_run_number}-$(date +'%Y%m%d')
              docker rmi iad.ocir.io/idjm2yj32zav/auditrite:$prev_tag
              docker run -d --name sod -p 9095:9095 -v /home/auditrite/SOD_Service/config:/app/config iad.ocir.io/idjm2yj32zav/auditrite:${{ env.DOCKER_TAG }}                
             
    
             
        
